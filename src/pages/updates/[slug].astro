---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Badge from "../../components/Badge.astro";
import { estimateReadingTimeMinutes } from "../../lib/readingTime";

export async function getStaticPaths() {
  const entries = await getCollection("updates", ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props as { entry: CollectionEntry<"updates"> };
const { Content } = await entry.render();
const minutes = estimateReadingTimeMinutes(entry.body ?? "");
const streamLabel = entry.data.type === "insight" ? "Insight" : "Firm update";
const showUpdated =
  !!entry.data.updatedDate && entry.data.updatedDate.valueOf() > entry.data.pubDate.valueOf();
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <section class="py-10 sm:py-14">
    <div class="mx-auto max-w-3xl container-px">
      <a href="/updates" class="text-sm font-medium text-brand no-underline hover:underline">
        ← Back to updates
      </a>

      <header class="mt-6 space-y-4">
        {entry.data.heroImage ? (
          <img
            src={entry.data.heroImage}
            alt=""
            width="1200"
            height="630"
            class="surface mb-6 h-auto w-full object-cover"
            loading="eager"
            decoding="async"
          />
        ) : null}
        <p class="text-xs font-semibold uppercase tracking-wider text-muted">
          {streamLabel}{entry.data.series ? ` • ${entry.data.series}` : ""}
        </p>
        <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">{entry.data.title}</h1>
        <p class="text-base leading-relaxed text-muted sm:text-lg">{entry.data.description}</p>

        <div class="flex flex-wrap items-center gap-3 text-sm text-muted">
          <time datetime={entry.data.pubDate.toISOString()}>
            {entry.data.pubDate.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "2-digit",
            })}
          </time>
          {entry.data.author ? <span>• {entry.data.author}</span> : null}
          {minutes ? <span>• {minutes} min read</span> : null}
          {showUpdated ? (
            <span>
              • Updated{" "}
              {entry.data.updatedDate.toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "2-digit",
              })}
            </span>
          ) : null}
        </div>

        {(entry.data.tags?.length || entry.data.series || entry.data.type) ? (
          <div class="flex flex-wrap gap-2">
            <Badge>{entry.data.type === "insight" ? "Insights" : "Firm updates"}</Badge>
            {entry.data.series ? <Badge>{entry.data.series}</Badge> : null}
            {entry.data.tags.map((t) => (
              <Badge>{t}</Badge>
            ))}
          </div>
        ) : null}
      </header>

      <article class="surface mt-8 p-6 sm:p-8">
        <div class="prose prose-slate max-w-none dark:prose-invert">
          <Content />
        </div>
      </article>
    </div>
  </section>
</BaseLayout>


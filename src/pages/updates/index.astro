---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Section from "../../components/Section.astro";
import UpdateCard from "../../components/UpdateCard.astro";
import { getCollection } from "astro:content";
import PageBanner from "../../components/PageBanner.astro";
import NewsletterSignup from "../../components/NewsletterSignup.astro";
import { IMAGES } from "../../images";

const entries = (await getCollection("updates", ({ data }) => !data.draft)).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const insights = entries.filter((e) => e.data.type === "insight");
const firm = entries.filter((e) => e.data.type === "firm");

const featuredFor = (list: typeof entries) =>
  list.find((e) => e.data.featured) ?? list[0];

const featuredInsight = featuredFor(insights);
const featuredFirm = featuredFor(firm);

const uniq = (xs: string[]) => Array.from(new Set(xs));

const tagsFor = (list: typeof entries) =>
  uniq(
    list
      .flatMap((e) => e.data.tags ?? [])
      .map((t) => t.trim())
      .filter(Boolean),
  ).sort((a, b) => a.localeCompare(b));

const insightTags = tagsFor(insights);
const firmTags = tagsFor(firm);
const allTags = tagsFor(entries);

const seriesFor = (list: typeof entries) =>
  uniq(
    list
      .map((e) => e.data.series)
      .filter((s): s is string => !!s?.trim())
      .map((s) => s.trim()),
  ).sort((a, b) => a.localeCompare(b));

const insightSeries = seriesFor(insights);
const firmSeries = seriesFor(firm);
const allSeries = seriesFor(entries);

const withoutFeatured = (list: typeof entries, featured?: (typeof entries)[number]) =>
  featured ? list.filter((e) => e.slug !== featured.slug) : list;

const insightsRest = withoutFeatured(insights, featuredInsight);
const firmRest = withoutFeatured(firm, featuredFirm);

const featuredSlugs = new Set(
  [featuredInsight?.slug, featuredFirm?.slug].filter((s): s is string => !!s),
);
const allRest = entries.filter((e) => !featuredSlugs.has(e.slug));
---

<BaseLayout title="Updates">
  <PageBanner src={IMAGES.hero.updates} alt="" overlay="strong" height="compact" />
  <Section
    eyebrow="News & insights"
    title="Investor updates and thought leadership"
    description="A structured Updates hub with two streams: Insights (evergreen frameworks) and Firm updates (time-bound communications)."
  >
    <div id="updates-root">
    <div class="surface mb-6 p-4 sm:p-5">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="flex items-center justify-between gap-3">
          <div
            class="inline-flex w-full overflow-hidden rounded-2xl border border-border bg-bg p-1 sm:w-auto"
            role="tablist"
            aria-label="Updates streams"
          >
            <button
              type="button"
              class="js-updates-tab flex-1 rounded-xl bg-card px-4 py-2 text-sm font-semibold text-fg shadow-sm transition hover:bg-card sm:flex-none"
              data-stream="all"
              role="tab"
              aria-selected="true"
            >
              All
            </button>
            <button
              type="button"
              class="js-updates-tab flex-1 rounded-xl px-4 py-2 text-sm font-semibold text-fg transition hover:bg-card sm:flex-none"
              data-stream="insight"
              role="tab"
              aria-selected="false"
            >
              Insights
            </button>
            <button
              type="button"
              class="js-updates-tab flex-1 rounded-xl px-4 py-2 text-sm font-semibold text-fg transition hover:bg-card sm:flex-none"
              data-stream="firm"
              role="tab"
              aria-selected="false"
            >
              Firm updates
            </button>
          </div>

          <a href="/updates/rss.xml" class="shrink-0 text-sm font-semibold text-brand no-underline hover:underline">
            RSS
          </a>
        </div>

        <div class="grid gap-3 sm:grid-cols-3 lg:w-[560px]">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wider text-muted" for="updates-tag">
              Tag
            </label>
            <select
              id="updates-tag"
              class="js-filter mt-2 h-11 w-full rounded-xl border border-border bg-bg px-3 text-sm text-fg shadow-sm outline-none transition focus:border-brand/60"
              name="tag"
            >
              <option value="__all__">All tags</option>
              <optgroup label="All" data-stream="all">
                {allTags.map((t) => (
                  <option value={t}>{t}</option>
                ))}
              </optgroup>
              <optgroup label="Insights" data-stream="insight">
                {insightTags.map((t) => (
                  <option value={t}>{t}</option>
                ))}
              </optgroup>
              <optgroup label="Firm updates" data-stream="firm">
                {firmTags.map((t) => (
                  <option value={t}>{t}</option>
                ))}
              </optgroup>
            </select>
          </div>

          <div>
            <label class="text-xs font-semibold uppercase tracking-wider text-muted" for="updates-series">
              Series
            </label>
            <select
              id="updates-series"
              class="js-filter mt-2 h-11 w-full rounded-xl border border-border bg-bg px-3 text-sm text-fg shadow-sm outline-none transition focus:border-brand/60"
              name="series"
            >
              <option value="__all__">All series</option>
              <optgroup label="All" data-stream="all">
                {allSeries.map((s) => (
                  <option value={s}>{s}</option>
                ))}
              </optgroup>
              <optgroup label="Insights" data-stream="insight">
                {insightSeries.map((s) => (
                  <option value={s}>{s}</option>
                ))}
              </optgroup>
              <optgroup label="Firm updates" data-stream="firm">
                {firmSeries.map((s) => (
                  <option value={s}>{s}</option>
                ))}
              </optgroup>
            </select>
          </div>

          <div class="flex items-end">
            <button
              type="button"
              class="js-clear inline-flex h-11 w-full items-center justify-center rounded-xl border border-border bg-card px-4 text-sm font-semibold text-fg shadow-sm transition hover:bg-bg"
            >
              Clear filters
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="js-stream" data-stream="all">
      {(featuredInsight || featuredFirm) ? (
        <div class="mb-6 grid gap-5 lg:grid-cols-2">
          {featuredInsight ? (
            <div class="surface overflow-hidden">
              <a
                href={`/updates/${featuredInsight.slug}`}
                data-tags={(featuredInsight.data.tags ?? []).map((t) => t.trim()).filter(Boolean).join("|")}
                data-series={featuredInsight.data.series ?? ""}
                class="block no-underline transition hover:shadow-soft"
              >
                <div class="p-6">
                  <p class="text-xs font-semibold uppercase tracking-wider text-muted">
                    Featured insight{featuredInsight.data.series ? ` • ${featuredInsight.data.series}` : ""}
                  </p>
                  <h2 class="mt-2 text-xl font-semibold tracking-tight sm:text-2xl">
                    {featuredInsight.data.title}
                  </h2>
                  <p class="mt-2 text-sm leading-relaxed text-muted">{featuredInsight.data.description}</p>
                  <p class="mt-4 text-sm font-semibold text-brand">Read the insight →</p>
                </div>
              </a>
            </div>
          ) : null}

          {featuredFirm ? (
            <div class="surface overflow-hidden">
              <a
                href={`/updates/${featuredFirm.slug}`}
                data-tags={(featuredFirm.data.tags ?? []).map((t) => t.trim()).filter(Boolean).join("|")}
                data-series={featuredFirm.data.series ?? ""}
                class="block no-underline transition hover:shadow-soft"
              >
                <div class="p-6">
                  <p class="text-xs font-semibold uppercase tracking-wider text-muted">Featured firm update</p>
                  <h2 class="mt-2 text-xl font-semibold tracking-tight sm:text-2xl">
                    {featuredFirm.data.title}
                  </h2>
                  <p class="mt-2 text-sm leading-relaxed text-muted">{featuredFirm.data.description}</p>
                  <p class="mt-4 text-sm font-semibold text-brand">Read the update →</p>
                </div>
              </a>
            </div>
          ) : null}
        </div>
      ) : null}

      <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-3">
        {allRest.map((e) => (
          <UpdateCard entry={e} />
        ))}
      </div>
      <div class="js-empty hidden surface mt-6 p-6 text-sm text-muted">
        No matching updates. Try clearing filters.
      </div>
    </div>

    <div class="js-stream hidden" data-stream="insight">
      {featuredInsight ? (
        <div class="surface mb-6 overflow-hidden">
          <a
            href={`/updates/${featuredInsight.slug}`}
            data-tags={(featuredInsight.data.tags ?? []).map((t) => t.trim()).filter(Boolean).join("|")}
            data-series={featuredInsight.data.series ?? ""}
            class="block no-underline transition hover:shadow-soft"
          >
            <div class="grid gap-0 md:grid-cols-12">
              {featuredInsight.data.heroImage ? (
                <img
                  src={featuredInsight.data.heroImage}
                  alt=""
                  width="1200"
                  height="630"
                  class="h-56 w-full object-cover md:col-span-5 md:h-full"
                  loading="eager"
                  decoding="async"
                />
              ) : null}
              <div
                class={`p-6 ${featuredInsight.data.heroImage ? "md:col-span-7" : "md:col-span-12"}`}
              >
                <p class="text-xs font-semibold uppercase tracking-wider text-muted">
                  Featured insight{featuredInsight.data.series ? ` • ${featuredInsight.data.series}` : ""}
                </p>
                <h2 class="mt-2 text-xl font-semibold tracking-tight sm:text-2xl">
                  {featuredInsight.data.title}
                </h2>
                <p class="mt-2 text-sm leading-relaxed text-muted">{featuredInsight.data.description}</p>
                <p class="mt-4 text-sm font-semibold text-brand">Read the insight →</p>
              </div>
            </div>
          </a>
        </div>
      ) : null}

      <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-3">
        {insightsRest.map((e) => (
          <UpdateCard entry={e} />
        ))}
      </div>
      <div class="js-empty hidden surface mt-6 p-6 text-sm text-muted">
        No matching Insights. Try clearing filters.
      </div>
    </div>

    <div class="js-stream hidden" data-stream="firm">
      {featuredFirm ? (
        <div class="surface mb-6 overflow-hidden">
          <a
            href={`/updates/${featuredFirm.slug}`}
            data-tags={(featuredFirm.data.tags ?? []).map((t) => t.trim()).filter(Boolean).join("|")}
            data-series={featuredFirm.data.series ?? ""}
            class="block no-underline transition hover:shadow-soft"
          >
            <div class="grid gap-0 md:grid-cols-12">
              {featuredFirm.data.heroImage ? (
                <img
                  src={featuredFirm.data.heroImage}
                  alt=""
                  width="1200"
                  height="630"
                  class="h-56 w-full object-cover md:col-span-5 md:h-full"
                  loading="eager"
                  decoding="async"
                />
              ) : null}
              <div
                class={`p-6 ${featuredFirm.data.heroImage ? "md:col-span-7" : "md:col-span-12"}`}
              >
                <p class="text-xs font-semibold uppercase tracking-wider text-muted">Featured firm update</p>
                <h2 class="mt-2 text-xl font-semibold tracking-tight sm:text-2xl">
                  {featuredFirm.data.title}
                </h2>
                <p class="mt-2 text-sm leading-relaxed text-muted">{featuredFirm.data.description}</p>
                <p class="mt-4 text-sm font-semibold text-brand">Read the update →</p>
              </div>
            </div>
          </a>
        </div>
      ) : null}

      <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-3">
        {firmRest.map((e) => (
          <UpdateCard entry={e} />
        ))}
      </div>
      <div class="js-empty hidden surface mt-6 p-6 text-sm text-muted">
        No matching Firm updates. Try clearing filters.
      </div>
    </div>

    <div class="mt-10">
      <NewsletterSignup source="updates" />
    </div>

    <script>
      (function () {
        const root = document.getElementById("updates-root");
        if (!root) return;

        const tabs = Array.from(root.querySelectorAll(".js-updates-tab"));
        const streams = Array.from(root.querySelectorAll(".js-stream"));
        const tagSelect = root.querySelector("#updates-tag");
        const seriesSelect = root.querySelector("#updates-series");
        const clearBtn = root.querySelector(".js-clear");

        let activeStream = "all";
        const active = new Map([
          ["all", { tag: "__all__", series: "__all__" }],
          ["insight", { tag: "__all__", series: "__all__" }],
          ["firm", { tag: "__all__", series: "__all__" }],
        ]);

        function setActiveStream(next) {
          activeStream = next;
          tabs.forEach((t) => {
            const on = t.getAttribute("data-stream") === next;
            t.setAttribute("aria-selected", String(on));
            t.classList.toggle("bg-card", on);
            t.classList.toggle("shadow-sm", on);
          });
          streams.forEach((s) => s.classList.toggle("hidden", s.getAttribute("data-stream") !== next));
          if (tagSelect) constrainSelectToActiveStream(tagSelect);
          if (seriesSelect) constrainSelectToActiveStream(seriesSelect);
          syncSelectsFromState();
          applyFilter();
        }

        function applyFilter() {
          const state = active.get(activeStream) || { tag: "__all__", series: "__all__" };
          const tag = state.tag || "__all__";
          const series = state.series || "__all__";
          const visibleStream = streams.find((s) => s.getAttribute("data-stream") === activeStream);
          if (!visibleStream) return;
          const cards = Array.from(visibleStream.querySelectorAll("[data-tags]"));
          let shown = 0;
          cards.forEach((el) => {
            const tags = (el.getAttribute("data-tags") || "").split("|").filter(Boolean);
            const s = (el.getAttribute("data-series") || "").trim();
            const byTag = tag === "__all__" || tags.includes(tag);
            const bySeries = series === "__all__" || s === series;
            const show = byTag && bySeries;
            el.classList.toggle("hidden", !show);
            if (show) shown += 1;
          });

          const empty = visibleStream.querySelector(".js-empty");
          if (empty) empty.classList.toggle("hidden", shown !== 0);
        }

        tabs.forEach((t) =>
          t.addEventListener("click", () => {
            setActiveStream(t.getAttribute("data-stream") || "all");
          }),
        );

        function syncSelectsFromState() {
          const state = active.get(activeStream) || { tag: "__all__", series: "__all__" };
          if (tagSelect) tagSelect.value = state.tag || "__all__";
          if (seriesSelect) seriesSelect.value = state.series || "__all__";
        }

        function constrainSelectToActiveStream(selectEl) {
          const groups = Array.from(selectEl.querySelectorAll("optgroup"));
          if (activeStream === "all") {
            groups.forEach((g) => g.toggleAttribute("disabled", false));
            return;
          }
          groups.forEach((g) =>
            g.toggleAttribute("disabled", g.getAttribute("data-stream") !== activeStream),
          );
        }

        if (tagSelect) {
          constrainSelectToActiveStream(tagSelect);
          tagSelect.addEventListener("change", () => {
            const state = active.get(activeStream) || { tag: "__all__", series: "__all__" };
            state.tag = tagSelect.value || "__all__";
            active.set(activeStream, state);
            applyFilter();
          });
        }

        if (seriesSelect) {
          constrainSelectToActiveStream(seriesSelect);
          seriesSelect.addEventListener("change", () => {
            const state = active.get(activeStream) || { tag: "__all__", series: "__all__" };
            state.series = seriesSelect.value || "__all__";
            active.set(activeStream, state);
            applyFilter();
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener("click", () => {
            active.set(activeStream, { tag: "__all__", series: "__all__" });
            syncSelectsFromState();
            applyFilter();
          });
        }

        setActiveStream(activeStream);
        syncSelectsFromState();
        if (tagSelect) constrainSelectToActiveStream(tagSelect);
        if (seriesSelect) constrainSelectToActiveStream(seriesSelect);
        applyFilter();
      })();
    </script>
    </div>
  </Section>
</BaseLayout>


---
const endpoint = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT as string | undefined;

const { searchParams } = Astro.url;
const sent = searchParams.get("sent") === "1";
const redirectTo = new URL("/contact?sent=1", Astro.url).toString();
---

<div
  id="contact-status-wrap"
  class:list={[
    "mb-6 overflow-hidden transition-[max-height,opacity] duration-300 ease-out",
    sent ? "max-h-40 opacity-100" : "max-h-0 opacity-0",
  ]}
>
  <div
    id="contact-status-success"
    class="surface border-brand/30 bg-brand/5 p-4 text-sm"
    role="status"
    aria-live="polite"
    tabindex="-1"
  >
    <p class="font-semibold">Message sent.</p>
    <p class="mt-1 text-muted">
      Thanks for reaching out—someone from our team will respond soon.
    </p>
  </div>
</div>

<div
  id="contact-error-wrap"
  class="mb-6 hidden"
  role="alert"
  aria-live="assertive"
>
  <div class="surface border-accent/30 bg-accent/5 p-4 text-sm">
    <p class="font-semibold">We couldn’t send your message.</p>
    <p id="contact-error-text" class="mt-1 text-muted">
      Please try again in a moment.
    </p>
  </div>
</div>

<form class="space-y-4" method="post" action={endpoint ?? "#"} data-formspree="contact">
  {!endpoint ? (
    <div class="surface border-accent/30 bg-accent/5 p-4 text-sm">
      <p class="font-semibold">Form not configured.</p>
      <p class="mt-1 text-muted">
        Set <span class="font-mono">PUBLIC_FORMSPREE_ENDPOINT</span> to enable submissions.
      </p>
    </div>
  ) : null}

  <input type="hidden" name="_subject" value="Olumie Capital — Contact form" />
  <input type="hidden" name="_next" value={redirectTo} />

  <div class="grid gap-4 sm:grid-cols-2" data-form-fields>
    <label class="space-y-1">
      <span class="text-sm font-medium">First name</span>
      <input
        name="firstName"
        autocomplete="given-name"
        placeholder="Jane"
        class="w-full rounded-xl border border-border bg-bg px-3 py-2 text-sm"
        required
        disabled={!endpoint}
      />
    </label>
    <label class="space-y-1">
      <span class="text-sm font-medium">Last name</span>
      <input
        name="lastName"
        autocomplete="family-name"
        placeholder="Doe"
        class="w-full rounded-xl border border-border bg-bg px-3 py-2 text-sm"
        required
        disabled={!endpoint}
      />
    </label>
  </div>

  <label class="space-y-1">
    <span class="text-sm font-medium">Email</span>
    <input
      type="email"
      name="email"
      autocomplete="email"
      placeholder="jane.doe@company.com"
      class="w-full rounded-xl border border-border bg-bg px-3 py-2 text-sm"
      required
      disabled={!endpoint}
    />
  </label>

  <label class="space-y-1">
    <span class="text-sm font-medium">Organization (optional)</span>
    <input
      name="organization"
      autocomplete="organization"
      placeholder="Olumie Capital"
      class="w-full rounded-xl border border-border bg-bg px-3 py-2 text-sm"
      disabled={!endpoint}
    />
  </label>

  <label class="space-y-1">
    <span class="text-sm font-medium">Message</span>
    <textarea
      name="message"
      rows="6"
      placeholder="A brief note about what you’d like to discuss (e.g., investment opportunity, partnership, or general inquiry)…"
      class="w-full rounded-xl border border-border bg-bg px-3 py-2 text-sm"
      required
      disabled={!endpoint}
    ></textarea>
  </label>

  <!-- Honeypot field for basic spam reduction -->
  <label class="hidden">
    <span>Company</span>
    <input name="company" tabindex="-1" autocomplete="off" />
  </label>

  <button
    type="submit"
    class="inline-flex w-full items-center justify-center rounded-xl bg-brand px-5 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-brand/90 sm:w-auto"
    disabled={!endpoint}
  >
    <span class="inline-flex items-center gap-2">
      <svg
        id="contact-spinner"
        class="hidden h-4 w-4 animate-spin text-white/90"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
          fill="none"
        />
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
        />
      </svg>
      <span id="contact-submit-label">Send message</span>
    </span>
  </button>

  <p class="text-xs text-muted">
    By submitting, you consent to receive a response to your inquiry. Do not include sensitive information.
  </p>
</form>

<script is:inline>
  (() => {
    const form = document.querySelector('form[data-formspree="contact"]');
    if (!form) return;

    const endpoint = form.getAttribute("action");
    if (!endpoint || endpoint === "#") return;

    const fields = form.querySelector("[data-form-fields]");
    const statusWrap = document.getElementById("contact-status-wrap");
    const successEl = document.getElementById("contact-status-success");
    const errorWrap = document.getElementById("contact-error-wrap");
    const errorText = document.getElementById("contact-error-text");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitButton = form.querySelector('button[type="submit"]');
      const submitLabel = form.querySelector("#contact-submit-label");
      const spinner = form.querySelector("#contact-spinner");

      const setSubmitting = (isSubmitting) => {
        form.toggleAttribute("aria-busy", isSubmitting);
        if (submitButton) submitButton.toggleAttribute("disabled", isSubmitting);
        if (spinner) spinner.classList.toggle("hidden", !isSubmitting);
        if (submitLabel) submitLabel.textContent = isSubmitting ? "Sending…" : "Send message";
        if (fields) fields.classList.toggle("opacity-60", isSubmitting);
      };

      const showSuccess = () => {
        if (!statusWrap) return;
        statusWrap.classList.remove("max-h-0", "opacity-0");
        statusWrap.classList.add("max-h-40", "opacity-100");
        if (successEl && typeof successEl.focus === "function") successEl.focus();
      };

      const hideError = () => {
        if (errorWrap) errorWrap.classList.add("hidden");
      };

      const showError = (message) => {
        if (errorText) errorText.textContent = message;
        if (errorWrap) errorWrap.classList.remove("hidden");
      };

      hideError();
      setSubmitting(true);

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          body: new FormData(form),
          headers: { Accept: "application/json" },
        });

        if (res.ok) {
          form.reset();
          showSuccess();
          history.replaceState({}, "", "/contact?sent=1");
          setSubmitting(false);
          if (submitButton) submitButton.setAttribute("disabled", "");
          if (submitLabel) submitLabel.textContent = "Sent";
          return;
        }

        setSubmitting(false);
        showError("Please try again in a moment.");
      } catch {
        setSubmitting(false);
        showError("Network error—please try again.");
      }
    });
  })();
</script>

